<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="../stylesheets/reseñas.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  
    <title>Reseñas Populares</title>
</head>
<body>

  <nav class="navbar navbar-expand-md navbar-dark" style = "background-color: #00182f;">
    <a class="navbar-brand" href="#">Rincón del Gaming</a>
    
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="inicio.html">Inicio<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="juegos.html">Juegos</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Reseñas
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="reseñas-recientes.html">Más recientes</a>
          <a class="dropdown-item active" href="reseñas-populares.html">Populares</a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#">Menos valoradas</a>
        </div>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <a href="acceder.html" class="btn btn-outline-success mr-sm-2 text-white">Acceder</a>
      <a href="registro.html" class="btn btn-outline-info my-2 my-sm-0 text-white">Registrar</a>
    </form>
  </nav>

  <div id="titulo">
    <div class="container" style="margin-top: 3%;">
      <h1 class="display-4 text-white text-center">Reseñas más populares</h1>
      <p class="display-5 text-muted text-center">
        Echale un vistazo a las reseñas más populares valorados por nuestros usuarios
      </p>
      <div class="container">
        <div class="d-flex justify-content-center " >    
         <div class="col-md-7">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <button id ="dpBuscar" class="btn btn-info dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Busqueda</button>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#">Autores</a>
                <a class="dropdown-item" href="#">Nombre de juego</a>
              </div>
            </div>
            <input type="text" id="busqueda" class="form-control bg-transparent text-white" aria-label="Text input with dropdown button" placeholder="">
            <span class="input-group-btn">
              <button class="btn btn-success" type="button">
                <span id="buscarReseña" class="glyphicon glyphicon-search">Buscar</span>
              </button>
            </span>
          </div>
         </div>
        </div>
      </div>
    </div>
  </div>

  <br>

  <div id= "Contenido" class="container" >
    <hr>
  </div>


  <footer class="mb-6 px-3 text-white text-center alt-text-small">
    <div class="col-md-6 mx-auto text-center text-gray-lighter">
      <section class="items">
        <nav class="main-nav">
          <a href="#"><span data-hover="FAQ">FAQ</span></a>
          <a href="#"><span data-hover="Terminos">Terminos</span></a>
          <a href="#"><span data-hover="Contacto">Contacto</span></a>
        </nav>
      </section>
    </div>
    <p class="nota"> © 2020 El Rincón Del Gaming</p>
  </footer>

</body>

<script>

  reviews = [];
  games = [];
  tipoBusqueda = "";

  function getGames() {
    $.get("http://localhost:3000/games", function (informacion) {
      games = informacion.respuesta;
    });
  };

  function getReviews() {
    $.ajax({
      url: "http://localhost:3000/reviews",
      type: "GET",
      error: function(){ 
        mostrarNotFound("El sistema se encuentra desactivado.")
      },
      success: function(informacion){
        reviews = informacion.respuesta;

        if(hayReviewsPopulares() != 0){
          reviews.forEach(function (review) {
            if(review.likes > 0 || review.dislikes > 0)
              addReview(review);
          });
        }else
          mostrarNotFound("No se encontraron reseñas populares.");
      }
    });
  }

  function hayReviewsPopulares(){
    return reviews.filter(function (review) {
        return review.likes > 0 && review.dislikes > 0
      });
  }

  function mostrarNotFound(text){
    $("#Contenido").append(
      '<div id="contenido">' + 
        '<div class="container" style="margin-top: 3%;">' +
          '<h1 class="display-3 text-muted text-center">Oops!</h1>' +
          '<p class="lead text-white text-center">' + text + '</p>' +
          '</div>' +
        '</div>' +
        '<hr><hr>'
    );
  }

  function likeReview(idReview){
    $.ajax({
      url: 'http://localhost:3000/reviews/like/' + idReview,
      type: 'PUT',
      success: function(result) {
        $("#Contenido").html("");
        getReviews();
      }
    });
  }

  function dislikeReview(idReview){
    $.ajax({
      url: 'http://localhost:3000/reviews/dislike/' + idReview,
      type: 'PUT',
      success: function(result) {
        $("#Contenido").html("");
        getReviews();
      }
    });
  }
  
  function addReview(review){
      $("#Contenido").append(
        '<div class="row d-flex justify-content-center">' +
          '<img  class="col-md-4" src="'+ games[review.idJuego].imagen + '" width="450" alt="" srcset="">' +
          '<div class="col-md-8 bg-secundary">' +
            '<h2 class="text-white text-left ">' + games[review.idJuego].nombre + '</h2>' +
            '<h5 class="text-dark text-left">' + review.autor + ', ' + review.day + '/' + review.month + '/'+ review.year + '</h5>' +
            '<p class = "lead text-white">' + review.descripcion + '</p>' +
          '</div>' +
        '</div>' +
        '<div class="row">' +
          '<div class="col-md-4 text-center">' +
          '<br>' +
          '<button type="button" onclick="likeFunction('+ review.id +')" class="btn btn-outline-success"> <span class="text-muted">' + review.likes + '</span> Me gusta</button>' +
          '&nbsp;&nbsp;'+
          '<button type="button" onclick="dislikeFunction('+ review.id +')"class="btn btn-outline-danger"> <span class="text-muted">' + review.dislikes + '</span> No me gusta </button>' +
        '</div>' +
        '</div>' +
        '<hr>' 
      );
  };

  function reviewFilter(type, text){

    if(type == "Autores"){
      return reviews.filter(function (review) {
        autor = review.autor.toLowerCase();
        return autor.indexOf(text) !== -1;
      });
    }

    if(type == "Nombre de juego"){
      return reviews.filter(function (review) {
        nombreJuego = games[review.idJuego].nombre.toLowerCase()
        return nombreJuego.indexOf(text) !== -1;
      });
    }
  }

  function textoVacio(str){
    return (!str || 0 === str.length);
  }

  $(document).ready(function () {

    getGames();
    getReviews();

    $("#busqueda").change(function (){

      textoEnBusqueda = $("#busqueda").val().toLowerCase();
      $("#Contenido").html("<hr>");

      if (/^ *$/.test(textoEnBusqueda) || /^ *$/.test(tipoBusqueda)) {
        return getReviews();
      } 

      reviewsEncontrados = reviewFilter(tipoBusqueda, textoEnBusqueda);
      
      if(reviewsEncontrados.length == 0)
        mostrarNotFound("No se encontrarón reseñas.");
      else{
        reviewsEncontrados.forEach(function (review){
          addReview(review);
        });
      }
    });

    
    $('.input-group-prepend').find('a').click(function(e){
			e.preventDefault();
			
      tipoBusqueda = $(this).text();
			$('#dpBuscar').text(tipoBusqueda);
		});
    
  });


</script>

</html>